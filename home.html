<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Shared Folders</title>
    <link rel="stylesheet" href="home.css">
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <header>
            <h1>Shared Folders</h1>
            <button id="logout-button">Logout</button>
            <button id="delete-folder-button">Delete Folder</button>

        </header>

        <!-- Main Section -->
        <main>
            <section class="create-folder">
                <h2>Create New Folder</h2>
                <form id="folder-form">
                    <input type="text" id="folder-name" placeholder="Folder Name" required>
                    <button type="submit">Create Folder</button>
                </form>
            </section>

            <section class="folder-list">
                <h2>Your Folders</h2>
                <ul id="folders">
                    <!-- Folders will be dynamically added here -->
                </ul>
            </section>
        </main>
    </div>

    <!-- Firebase SDK (load as ES Modules) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-storage.js";
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB1wwcVJpZHraOaJOG1w5yFDJEk_T-6qBk",
            authDomain: "folder-sharing-f7df9.firebaseapp.com",
            projectId: "folder-sharing-f7df9",
            storageBucket: "folder-sharing-f7df9.appspot.com",
            messagingSenderId: "464700051533",
            appId: "1:464700051533:web:612e3e27ae3624ee8b4c04",
            measurementId: "G-9Q7SYT6BWF"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();
        const storage = getStorage(app);
    
        // Add event listener to the logout button
        document.getElementById('logout-button').addEventListener('click', function() {
            window.location.href = 'index.html';
        });
    
        // Handle folder creation
        document.getElementById('folder-form').addEventListener('submit', async (e) => {
            e.preventDefault();
    
            const folderName = document.getElementById('folder-name').value;
    
            try {
                // Add folder to Firestore
                const docRef = await addDoc(collection(db, "folders"), {
                    name: folderName,
                    createdAt: new Date(),
                    createdBy: auth.currentUser.uid
                });
                console.log("Folder created with ID: ", docRef.id);
                document.getElementById('folder-name').value = '';  // Clear input
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        });
    
        // Function to fetch and display folders in real-time
// Function to fetch and display folders in real-time
async function fetchFolders() {
    const foldersContainer = document.getElementById('folders');
    
    // Set up real-time listener for Firestore collection 'folders'
    const unsubscribe = onSnapshot(collection(db, "folders"), (querySnapshot) => {
        querySnapshot.forEach((doc) => {
            const folderData = doc.data();
            const folderItem = document.createElement('li');
            folderItem.classList.add('folder-item');
            folderItem.textContent = folderData.name;
            folderItem.setAttribute('data-id', doc.id);  // Add folder ID to each folder item

            // Add click event to open folder
            folderItem.addEventListener('click', function() {
                openFolder(doc.id);  // Open folder using its ID
            });

            // Check if folder already exists in the list to avoid duplication
            if (!foldersContainer.querySelector(`[data-id="${doc.id}"]`)) {
                foldersContainer.appendChild(folderItem);
            }
        });
    });

    // To stop listening for changes, you can call unsubscribe()
    // unsubscribe();
}

    
        // Function to handle folder click (open the folder)
        function openFolder(folderId) {
            // Example: Navigate to a new page with the folder ID in the URL (optional)
            window.location.href = `folder.html?folderId=${folderId}`;
        }
    
        // Fetch folders when the page loads
        window.onload = fetchFolders;
    
        // Example of file upload to Firebase Storage
        async function uploadFile(file, folderId) {
            const storageRef = ref(storage, `folders/${folderId}/${file.name}`);
            await uploadBytes(storageRef, file);
            console.log('File uploaded successfully');
        }
        // Add event listener to delete folder button
document.getElementById('delete-folder-button').addEventListener('click', async function() {
    const confirmDelete = confirm("Are you sure you want to delete this folder and all its contents?");
    if (confirmDelete) {
        try {
            // Delete the folder in Firestore
            await deleteFolderFromFirestore(folderId);
            
            // Delete files from Cloudinary (optional if you want to delete them too)
            await deleteFilesFromCloudinary(folderId);

            // Redirect to home or folder list page after deletion
            window.location.href = 'home.html'; // Or redirect to any other page
        } catch (error) {
            console.error("Error deleting folder: ", error);
            alert("There was an error deleting the folder.");
        }
    }
});

// Function to delete folder from Firestore
async function deleteFolderFromFirestore(folderId) {
    try {
        const folderDocRef = doc(db, "folders", folderId);
        await deleteDoc(folderDocRef);  // This deletes the folder document

        // Delete all files associated with this folder in Firestore
        const filesRef = collection(db, "folders", folderId, "files");
        const filesSnapshot = await getDocs(filesRef);
        filesSnapshot.forEach(async (fileDoc) => {
            await deleteDoc(fileDoc.ref);  // Delete each file document from Firestore
        });
    } catch (error) {
        console.error("Error deleting folder from Firestore: ", error);
        throw new Error("Failed to delete folder from Firestore");
    }
}

// Function to delete all files from Cloudinary (optional)
async function deleteFilesFromCloudinary(folderId) {
    try {
        // Get all files in the folder (we already have their public IDs stored in Firestore)
        const filesRef = collection(db, "folders", folderId, "files");
        const filesSnapshot = await getDocs(filesRef);
        
        filesSnapshot.forEach(async (fileDoc) => {
            const fileData = fileDoc.data();
            const publicId = fileData.public_id;
            
            // Make a request to Cloudinary to delete the file
            const cloudinaryDeleteUrl = `https://api.cloudinary.com/v1_1/dlj56dege/delete_by_public_id`;
            const response = await fetch(cloudinaryDeleteUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    public_id: publicId,
                    api_key: 'your_cloudinary_api_key', // Replace with your Cloudinary API key
                    api_secret: 'your_cloudinary_api_secret', // Replace with your Cloudinary API secret
                })
            });
            
            if (response.ok) {
                console.log(`File with public ID ${publicId} deleted successfully.`);
            } else {
                console.error("Error deleting file from Cloudinary:", await response.text());
            }
        });
    } catch (error) {
        console.error("Error deleting files from Cloudinary: ", error);
        throw new Error("Failed to delete files from Cloudinary");
    }
}

    
    </script>
    

</body>
</html>
